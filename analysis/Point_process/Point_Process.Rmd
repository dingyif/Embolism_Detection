---
title: "Point Process"
author: "Diane Lu"
date: "May 31st, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if (!require("RColorBrewer")) {
install.packages("RColorBrewer")
library(RColorBrewer)
}

if (!require("MASS")) {#fitdistr
install.packages("MASS")
library(MASS)
}

#Modelling and Validation of Non Homogeneous Poisson Processes
if (!require("NHPoisson")) {
  install.packages("NHPoisson")
  library(NHPoisson)
}

if (!require("ztable")) {
install.packages("ztable")
library(ztable)
}

options(ztable.type = "html")

source("HawkesFunctions.R")
library(ggplot2)
library(magrittr)#for %>%
```


```{r load data}
dir_path <- '../../output'
all_inter_event_dist_time <- read.csv(file.path(dir_path,'all_inter_event_dist_time.csv'), header = TRUE)

all_folders_name_short <- unique(all_inter_event_dist_time$folder_name)
all_species <- unique(all_inter_event_dist_time$species)
all_rel_exp_idx <- unique(all_inter_event_dist_time$rel_exp_idx)
```

```{r, eval=FALSE, include=FALSE}
total_ss<- read.csv(file.path(dir_path, 'total_summary_stats.csv'), header = TRUE)
#times_1 <- total_ss[all_inter_event_dist_time$folder_name == folder_name_i,]$time_since_start.mins.
```

## Inter-Event Time (aligning the first event time)

```{r plot_event_time}

x_max <- max(all_inter_event_dist_time$inter_event_time.min.)
x_step <- as.integer(x_max/10)

margin_btw_folders <- 0.5
margin_btw_title <- 0.1
y_max <- 0.7 + margin_btw_title*2+ margin_btw_folders*(length(all_folders_name_short)-1)
plot(0.5,0,xlim=c(-0.2,x_max),ylim=c(0.7,y_max), type="n",
     xlab="Time (Mins)",ylab="",xaxt="n",yaxt="n",cex.lab=1.2,bty="n")
#title("(a)",line=1,cex.main=2)
axis(2,at=c(1,2),labels=FALSE,cex.lab=1.8,las=2,lwd=0,lwd.ticks=0)
axis(1,at=seq(0,x_max,x_step),labels=FALSE,cex.lab=1.8,las=2,lwd=1.5,lwd.ticks=1)#x-axis ticks
text(seq(0,x_max,x_step), y=-0.5, labels=seq(0,x_max,x_step), cex=1, srt=0, xpd=TRUE)#numbers at x-axis ticks

segments(x0=0.1,x1=x_max,y0=y_max - margin_btw_title,col="lightgrey",lwd=2)#light gray line

color_list <- brewer.pal(length(all_species),"Set1")

y_prev <- 0.7 + margin_btw_title*1 + margin_btw_folders*length(all_folders_name_short)

few_emb_th <- 20 #if the folder has total number of embolized img < few_emb_th, consider it as folder with few embolism
few_emb_folders <- NULL
for(folder_i in 1:length(all_folders_name_short)){
  folder_name_i<- all_folders_name_short[folder_i]
  inter_event_dist_time <- all_inter_event_dist_time[all_inter_event_dist_time$folder_name == folder_name_i,]
  inter_event_time <- inter_event_dist_time$inter_event_time.min.
  times_i <- cumsum(inter_event_time)
  times_i <- append(times_i, 0, after=0)#insert the first event time as 0
  
  if(length(times_i)<few_emb_th){
    few_emb_folders <- c(few_emb_folders,folder_i)
  }
  
  #get species to determine the color 
  species_idx = as.numeric(unique(inter_event_dist_time["species"]))#as.numeric: factor df to integer
  #plot the event time for folder_i
  y_i <- y_prev - margin_btw_folders
  points(times_i,rep(y_i,length(times_i)),pch=4,col = color_list[species_idx],cex=1,lwd=2)
  #plot the folder_name_i
  text(-100, y=y_i, labels=folder_name_i, cex=0.8, srt=0, xpd=TRUE)
  
  y_prev <- y_i
}

title("Inter-Event Time (aligning the first event time)")
```


## Fitting Poisson Process to Each Experiment

Assumes inter-event times are independent.
Intensity: expected inter-event times = 1/lambda

```{r PP, warning=FALSE, message=FALSE}
max_plot_row <- 2
all_PP_param <- NULL
for(folder_i in 1:length(all_folders_name_short)){
  if(folder_i%%max_plot_row==1){# a new fig
    par(mfrow=c(max_plot_row,3),mar=c(5,4,7,3))#,oma = c(0, 0, 2, 0))# outer margin area (bottom,left,top,right)
  }
  folder_name_i<- all_folders_name_short[folder_i]
  inter_event_dist_time <- all_inter_event_dist_time[all_inter_event_dist_time$folder_name == folder_name_i,]
  inter_event_time <- inter_event_dist_time$inter_event_time.min.
  times_i <- cumsum(inter_event_time)
  times_i <- append(times_i, 0, after=0)#insert the first event time as 0
  
  #get species to determine the color 
  species_idx = as.numeric(unique(inter_event_dist_time["species"]))#as.numeric: factor df to integer
  
  ## fit a poisson process
  fitPP_1<-fitPP.fun(posE=times_i,n=max(times_i),start=list(b0=0),dplot = FALSE, modSim = TRUE) 
  # b0=0 is our guess at initial value for optimization, which is internally made with `nlminb` function
  # b0 (=fitPP_1@coef) is actually log lambda
  # https://cran.r-project.org/web/packages/NHPoisson/NHPoisson.pdf
  # dplot = FALSE: suppress plotting. modSim=TRUE: suppress printing
  # [ref]: NHPoisson: An R Package for Fitting and Validating Nonhomogeneous Poisson Processes
  # TODO: include cc_area as intensity

  intensity = exp(fitPP_1@coef)#fitted lambda for Poisson
  
  #scaled inter_event_time (scaled by lambda)
  lambda_res = inter_event_time*as.numeric(intensity)
  
  
  
  ## Histogram of inter-event times fitted by exponential dist
  #estimate the parameters for exponential dist
  fit_exp <- fitdistr(inter_event_time, "exponential") 
  hist(inter_event_time, freq = FALSE, breaks = 50, xlim = c(0, quantile(inter_event_time, 0.99)), main = "Histogram of Inter-Event Times", col = color_list[species_idx])
  curve(dexp(x, rate = fit_exp$estimate), from = 0, col = "red", add = TRUE)
  
  
  
  
  ## QQ Plot using inter-event times
  p <- ppoints(100)    # 100 equally spaced points on (0,1), excluding endpoints
  q <- quantile(lambda_res,p=p,na.rm=TRUE) # percentiles of the sample distribution
  plot(qexp(p),q, xlab="Theoretical Quantiles",ylab="Empirical Quantiles",cex.lab=1.2,
        pch=1,cex=1.1,col="Black",
       main = paste("Poisson Process\n intensity(lambda)=",round(intensity,2)))
  
  qqline(q, distribution=qexp,col="Red", lty=1, lwd=2.5)
  
  #folder name should be printed at top (side=3) of 2nd subplot
  mtext(folder_name_i, side=3, line=5)
  #https://www.r-graph-gallery.com/74-margin-and-oma-cheatsheet.html
  
  
  
  ## KS Statistic
  ks_pp <- ks.test(lambda_res,"pexp")
  # Warning message:
  # In ks.test(lambda_res, "pexp") :
  #   ties should not be present for the Kolmogorov-Smirnov test
  # Interpretation: The K-S test is for a "continuous distribution" and so your data should not contain any ties (repeated values).
  # (exponetial dist is "continuous")
  # statistic (D): sup |F_n(x)-F(x)|: supreme of absolute difference of empirical CDF and 
  
  ## KS Plot
  #exponential CDF
  curve(pexp(x,1), min(lambda_res),max(lambda_res),col="Black",
        xlab="Compensator",ylab="CDF",cex.lab=1.2, main = paste("CDF of Inter-Event Times \n p-val=",round(ks_pp$p.value,2), ", K-S statistic (D)=",round(ks_pp$statistic,2)))
  #empirical CDF
  plot(ecdf(lambda_res), add=TRUE, do.points=FALSE, col.01line = "white", verticals=TRUE,col="Red", lwd=3.5, ylim=c(0,1))
  legend("bottomright",c("Exponential CDF","Empirical CDF"),lty=1,lwd=2,col=c("Black","Red"),
         bty="n",cex=1.2)
  
  PP_param_i <- c(folder_i, species_idx,intensity, ks_pp$p.value, ks_pp$statistic)
  all_PP_param <- rbind(all_PP_param,PP_param_i)
  
}
```

```{r PP_param}
all_PP_param <- data.frame(all_PP_param)
row.names(all_PP_param) <- all_folders_name_short
colnames(all_PP_param) <- c("folder_index","species","lambda","KS_pval","KS_D")
all_PP_param$not_few_emb <- 1.0
all_PP_param$not_few_emb[few_emb_folders] <- 0.2#determines how transparent the bar will be when plotted
```




## Fit Hawkes Process

Kernel: exponential decay

$$
\lambda(t) = \lambda_0 + \alpha \sum_{i:t_i < t} e^{-\beta(t-t_i)}
$$

```{r Hawkes_process, warning=FALSE}
max_plot_row <- 2
all_HP_param <- NULL

for(folder_i in 1:length(all_folders_name_short)){
  if(folder_i%%max_plot_row==1){# a new fig
    par(mfrow=c(max_plot_row,3),mar=c(5,4,7,3))#,oma = c(0, 0, 2, 0))# outer margin area (bottom,left,top,right)
  }
  folder_name_i<- all_folders_name_short[folder_i]
  inter_event_dist_time <- all_inter_event_dist_time[all_inter_event_dist_time$folder_name == folder_name_i,]
  inter_event_time <- inter_event_dist_time$inter_event_time.min.
  times_i <- cumsum(inter_event_time)
  times_i <- append(times_i, 0, after=0)#insert the first event time as 0
  
  
  #get species to determine the color 
  species_idx = as.numeric(unique(inter_event_dist_time["species"]))#as.numeric: factor df to integer
  
  ## fit hawkes process
  hawkes.par<-optim(par=rep(0.01,3), fn=uniHawkesNegLogLik, 
                    t=times_i, control = list(maxit = 1000) )
  #hawkes.par$convergence
  
  #fitted parameters
  HP_lam0 <- hawkes.par$par[1]
  HP_alpha <- hawkes.par$par[2]
  HP_beta <- hawkes.par$par[3]
  Lambda.test<-uniHawkesCompensator(lambda0=HP_lam0,alpha=HP_alpha,beta=HP_beta,
                                    times_i)
  ks.test(Lambda.test,"pexp")
  
  
  
  ## Histogram of inter-event times fitted by exponential dist
  #estimate the parameters for exponential dist
  fit_exp <- fitdistr(inter_event_time, "exponential") 
  hist(inter_event_time, freq = FALSE, breaks = 50, xlim = c(0, quantile(inter_event_time, 0.99)), main = "Histogram of Inter-Event Times", col = color_list[species_idx])
  curve(dexp(x, rate = fit_exp$estimate), from = 0, col = "red", add = TRUE)
  
  
  
  
  ## QQ Plot using inter-event times
  p <- ppoints(100)    # 100 equally spaced points on (0,1), excluding endpoints
  q <- quantile(Lambda.test,p=p,na.rm=TRUE) # percentiles of the sample distribution
  plot(qexp(p),q, xlab="Theoretical Quantiles",ylab="Empirical Quantiles",cex.lab=1.2,
        pch=1,cex=1.1,col="Black", main = "Hawkes Process")
  qqline(q, distribution=qexp,col="Red", lty=1, lwd=2.5)
  
  #folder name should be printed at top (side=3) of 2nd subplot
  mtext(folder_name_i, side=3, line=5)
  #https://www.r-graph-gallery.com/74-margin-and-oma-cheatsheet.html
  
  
  
  ## KS Statistic
  ks_pp <- ks.test(Lambda.test,"pexp")
  # Warning message:
  # In ks.test(lambda_res, "pexp") :
  #   ties should not be present for the Kolmogorov-Smirnov test
  # Interpretation: The K-S test is for a "continuous distribution" and so your data should not contain any ties (repeated values).
  # (exponetial dist is "continuous")
  # statistic (D): sup |F_n(x)-F(x)|: supreme of absolute difference of empirical CDF and 
  
  ## KS Plot
  #exponential CDF
  curve(pexp(x,1), min(Lambda.test),max(Lambda.test),col="Black",
        xlab="Compensator",ylab="CDF",cex.lab=1.2, main = paste("CDF of Inter-Event Times \n p-val=",round(ks_pp$p.value,2), ", K-S statistic (D)=",round(ks_pp$statistic,2)))
  #empirical CDF
  plot(ecdf(Lambda.test), add=TRUE, do.points=FALSE, col.01line = "white", verticals=TRUE,col="Red", lwd=3.5, ylim=c(0,1))
  legend("bottomright",c("Exponential CDF","Empirical CDF"),lty=1,lwd=2,col=c("Black","Red"),
         bty="n",cex=1.2)
  
  HP_param_i <- c(folder_i, species_idx,HP_lam0,HP_alpha,HP_beta,ks_pp$p.value,ks_pp$statistic)
  all_HP_param <- rbind(all_HP_param,HP_param_i)
  
}


```

### Look at the fitted parameters of Hawkes Process

Experiments with the number of embolized images < 20 are plotted with more transparent color.



```{r HP_param, warning=FALSE}
all_HP_param <- data.frame(all_HP_param)
row.names(all_HP_param) <- all_folders_name_short
colnames(all_HP_param) <- c("folder_index","species","lambda0","alpha","beta", "KS_pval", "KS_D")
all_HP_param$not_few_emb <- 1.0
all_HP_param$not_few_emb[few_emb_folders] <- 0.2#determines how transparent the bar will be when plotted
print(all_HP_param)

HP_param_no_few_emb <- all_HP_param[!(all_HP_param$folder_index %in% few_emb_folders),]
#print(HP_param_no_few_emb)


ggplot(all_HP_param, aes(x = folder_index,y = lambda0, fill = factor(species))) + 
  scale_fill_brewer(palette="Set1") +
  geom_bar(stat = "identity",alpha=all_HP_param$not_few_emb) +
  ggtitle("lambda0") +
  coord_cartesian(ylim=c(min(HP_param_no_few_emb$lambda0),max(HP_param_no_few_emb$lambda0)))
  

ggplot(all_HP_param, aes(x = folder_index,y = alpha, fill = factor(species))) + 
  scale_fill_brewer(palette="Set1") +
  geom_bar(stat = "identity",alpha=all_HP_param$not_few_emb) +
  ggtitle("alpha") +
  coord_cartesian(ylim=c(min(HP_param_no_few_emb$alpha),max(HP_param_no_few_emb$alpha)))

ggplot(all_HP_param, aes(x = folder_index,y = beta, fill = factor(species))) + 
  scale_fill_brewer(palette="Set1") +
  geom_bar(stat = "identity",alpha=all_HP_param$not_few_emb) +
  ggtitle("beta")+
  coord_cartesian(ylim=c(min(HP_param_no_few_emb$beta),max(HP_param_no_few_emb$beta)))
```



```{r, results="asis"}
param_2_methods <- merge(all_HP_param,all_PP_param,by="folder_index")
col_keep <- c("folder_index","species.x","KS_pval.x","KS_pval.y","not_few_emb.x")
pval_2_methods <- param_2_methods[, colnames(param_2_methods) %in% col_keep]
colnames(pval_2_methods) <- c("folder_index","species","KS_pval_HP","not_few_emb","KS_pval_PP")
pval_2_methods$incr_p_val <- pval_2_methods$KS_pval_HP - pval_2_methods$KS_pval_PP
pval_2_methods <- pval_2_methods[,c(1,2,5,3,6,4)]#change the order of column for better printing
ztable(pval_2_methods,caption="Change in P-values") %>%
    addRowColor(rows=1,bg="#C90000",color="white") %>%
    addCellColor(condition=incr_p_val>0.0,cols=incr_p_val,color="emerald") 
```

